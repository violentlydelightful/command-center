<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="dashboard">
        <header class="header">
            <div class="header-left">
                <h1>Command Center</h1>
                <span class="status" id="status">Connecting...</span>
            </div>
            <div class="header-right">
                <span class="timestamp" id="timestamp"></span>
                <button class="btn-refresh" onclick="refreshAll()">Refresh</button>
            </div>
        </header>

        <main class="grid">
            <!-- AI Briefing - Left column, full height -->
            <section class="widget briefing-widget">
                <div class="widget-header">
                    <h2>Daily Briefing</h2>
                    <span class="widget-badge" id="ai-badge">AI</span>
                </div>
                <div class="widget-content" id="briefing-content">
                    <div class="loading">Generating...</div>
                </div>
                <button class="btn-regenerate" onclick="loadBriefing()">Regenerate</button>
            </section>

            <!-- Weather Widget -->
            <section class="widget weather-widget">
                <div class="widget-header">
                    <h2>Weather</h2>
                    <input type="text" id="city-input" value="New York" class="city-input" onchange="loadWeather()">
                </div>
                <div class="widget-content" id="weather-content">
                    <div class="loading">...</div>
                </div>
            </section>

            <!-- Markets Widget -->
            <section class="widget stocks-widget">
                <div class="widget-header">
                    <h2>Markets</h2>
                </div>
                <div class="widget-content" id="stocks-content">
                    <div class="loading">...</div>
                </div>
            </section>

            <!-- Headlines - Right column, full height -->
            <section class="widget news-widget">
                <div class="widget-header">
                    <h2>Headlines</h2>
                </div>
                <div class="widget-content" id="news-content">
                    <div class="loading">...</div>
                </div>
            </section>

            <!-- GitHub Trending -->
            <section class="widget github-widget">
                <div class="widget-header">
                    <h2>Trending</h2>
                </div>
                <div class="widget-content" id="github-content">
                    <div class="loading">...</div>
                </div>
            </section>

            <!-- Quote -->
            <section class="widget quote-widget">
                <div class="widget-header">
                    <h2>Inspiration</h2>
                </div>
                <div class="widget-content" id="quote-content">
                    <div class="loading">...</div>
                </div>
            </section>
        </main>

        <footer>
            <span id="source-count">5</span> sources &bull; Updated <span id="last-update">--</span>
        </footer>
    </div>

    <script>
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        setInterval(updateTimestamp, 1000);
        updateTimestamp();

        async function loadWeather() {
            const city = document.getElementById('city-input').value;
            try {
                const res = await fetch(`/api/widget/weather?city=${encodeURIComponent(city)}`);
                const data = await res.json();
                renderWeather(data);
            } catch (e) {
                document.getElementById('weather-content').innerHTML = '<div class="error">Failed</div>';
            }
        }

        async function loadStocks() {
            try {
                const res = await fetch('/api/widget/stocks');
                const data = await res.json();
                renderStocks(data);
            } catch (e) {
                document.getElementById('stocks-content').innerHTML = '<div class="error">Failed</div>';
            }
        }

        async function loadNews() {
            try {
                const res = await fetch('/api/widget/news');
                const data = await res.json();
                renderNews(data);
            } catch (e) {
                document.getElementById('news-content').innerHTML = '<div class="error">Failed</div>';
            }
        }

        async function loadGithub() {
            try {
                const res = await fetch('/api/widget/github');
                const data = await res.json();
                renderGithub(data);
            } catch (e) {
                document.getElementById('github-content').innerHTML = '<div class="error">Failed</div>';
            }
        }

        async function loadQuote() {
            try {
                const res = await fetch('/api/widget/quote');
                const data = await res.json();
                renderQuote(data);
            } catch (e) {
                document.getElementById('quote-content').innerHTML = '<div class="error">Failed</div>';
            }
        }

        async function loadBriefing() {
            document.getElementById('briefing-content').innerHTML = '<div class="loading">Generating...</div>';
            try {
                const city = document.getElementById('city-input').value;
                const res = await fetch(`/api/briefing?city=${encodeURIComponent(city)}`);
                const data = await res.json();
                renderBriefing(data);
            } catch (e) {
                document.getElementById('briefing-content').innerHTML = '<div class="error">Failed</div>';
            }
        }

        function renderWeather(data) {
            const container = document.getElementById('weather-content');
            if (data.error && !data.demo) {
                container.innerHTML = `<div class="error">${data.error}</div>`;
                return;
            }
            const w = data.data;
            container.innerHTML = `
                <div class="weather-display">
                    <div class="temp-main">${w.temp}°</div>
                    <div class="condition">${w.condition}</div>
                    <div class="weather-details">
                        <span>H:${w.feels_like || w.temp}°</span>
                        <span>L:${Math.round(w.temp * 0.85)}°</span>
                    </div>
                </div>
            `;
        }

        function renderStocks(data) {
            const container = document.getElementById('stocks-content');
            if (!data.data || typeof data.data === 'string') {
                container.innerHTML = `<div class="error">${data.data || 'No data'}</div>`;
                return;
            }
            const formatPrice = (p) => p > 1000 ? `${(p/1000).toFixed(1)}K` : p.toFixed(2);
            container.innerHTML = `
                <div class="stocks-list">
                    ${data.data.map(s => `
                        <div class="stock-item ${s.change_pct >= 0 ? 'positive' : 'negative'}">
                            <span class="stock-symbol">${s.symbol}</span>
                            <div class="stock-info">
                                <span class="stock-price">$${formatPrice(s.price)}</span>
                                <span class="stock-change">${s.change_pct >= 0 ? '+' : ''}${s.change_pct.toFixed(2)}%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderNews(data) {
            const container = document.getElementById('news-content');
            if (!data.data) {
                container.innerHTML = '<div class="error">No news</div>';
                return;
            }
            container.innerHTML = `
                <div class="news-list">
                    ${data.data.slice(0, 8).map(n => `
                        <div class="news-item">
                            <span class="news-title">${n.title}</span>
                            <span class="news-source">${n.source}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderGithub(data) {
            const container = document.getElementById('github-content');
            if (!data.data) {
                container.innerHTML = '<div class="error">No data</div>';
                return;
            }
            const formatStars = (s) => s > 1000 ? `${(s/1000).toFixed(1)}k` : s;
            container.innerHTML = `
                <div class="github-list">
                    ${data.data.slice(0, 5).map(r => `
                        <div class="github-item">
                            <span class="repo-name">${r.name.split('/')[1] || r.name}</span>
                            <span class="repo-stars">${formatStars(r.stars)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderQuote(data) {
            const container = document.getElementById('quote-content');
            if (!data.data) {
                container.innerHTML = '<div class="error">No quote</div>';
                return;
            }
            const text = data.data.text.length > 120 ? data.data.text.substring(0, 117) + '...' : data.data.text;
            container.innerHTML = `
                <blockquote class="quote-display">
                    <p>"${text}"</p>
                    <cite>— ${data.data.author}</cite>
                </blockquote>
            `;
        }

        function renderBriefing(data) {
            const container = document.getElementById('briefing-content');
            const badge = document.getElementById('ai-badge');

            badge.textContent = data.ai_powered ? 'AI' : 'Auto';
            badge.className = `widget-badge ${data.ai_powered ? 'ai' : 'demo'}`;

            let content = data.briefing
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            container.innerHTML = `
                <div class="briefing-text">${content}</div>
                <div class="briefing-meta">${new Date(data.generated_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
        }

        async function refreshAll() {
            document.getElementById('status').textContent = 'Refreshing...';
            await Promise.all([
                loadWeather(),
                loadStocks(),
                loadNews(),
                loadGithub(),
                loadQuote(),
                loadBriefing()
            ]);
            document.getElementById('status').textContent = 'Live';
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        refreshAll();
    </script>
</body>
</html>
